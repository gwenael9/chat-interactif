<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- CSS -->
    <link rel="stylesheet" href="../css/groupChat.css">
</head>
<body>

<div class="chat-layout">

    <!-- LISTE DES CONVERSATIONS (COLONNE GAUCHE) -->
    <aside class="chat-sidebar">
        <header class="sidebar-header">
            <h3>Conversations</h3>
        </header>

        <nav class="chat-sidebar-nav">
            <a href="landingPage.html" class="nav-link active">
                <i class="fa-solid fa-comments"></i> Conversations
            </a>
            <a href="landingPage.html" class="nav-link">
                <i class="fa-solid fa-address-book"></i> Contacts
            </a>
            <a href="createConversation.html" class="nav-link">
                <i class="fa-solid fa-plus"></i> Nouvelle conversation
            </a>
        </nav>

        <ul id="conversationList" class="conversation-list"></ul>
    </aside>

    <!-- ZONE DE CHAT (COLONNE DROITE) -->
    <div class="chat-container">

        <!-- HEADER -->
        <header class="chat-header">
            <div class="group-info">
                <i class="fa-solid fa-users"></i>
                <div>
                    <h4 id="conversationName">Sélectionnez une conversation</h4>
                    <span id="memberCount"></span>
                </div>
            </div>
        </header>

        <!-- MESSAGES -->
        <main class="chat-messages" id="messagesContainer"></main>

        <!-- INPUT -->
        <footer class="chat-input">
            <input type="text" id="messageInput" placeholder="Écrire un message..." />
            <button onclick="sendMessage()">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </footer>

    </div>

</div>

<script>
const API_URL = "http://localhost:4000";
let socket;
let currentConversationId = null;
let currentUser;
let conversations = [];

// ---------------- Utilisateur connecté ----------------
async function getCurrentUser() {
    const response = await fetch(`${API_URL}/auth/me`, {
        credentials: "include"
    });

    if (!response.ok) {
        window.location.href = "login.html";
        return;
    }

    currentUser = await response.json();
}

async function loadConversationInfo() {
    if (!currentConversationId) return;
    const response = await fetch(
        `${API_URL}/chat/conversations/${currentConversationId}`,
        { credentials: "include" }
    );

    if (!response.ok) {
        alert("Conversation introuvable");
        return;
    }

    const conversation = await response.json();

    document.getElementById("conversationName").textContent = conversation.name;
    document.getElementById("memberCount").textContent =
        `${conversation.participants.length} membre${conversation.participants.length > 1 ? "s" : ""}`;
}


// ---------------- Charger historique ----------------
async function loadMessages() {
    if (!currentConversationId) return;
    const response = await fetch(
        `${API_URL}/chat/conversations/${currentConversationId}/messages`,
        { credentials: "include" }
    );

    const messages = await response.json();
    const container = document.getElementById("messagesContainer");
    container.innerHTML = "";

    messages.forEach(msg => renderMessage(msg));
}

// ---------------- Afficher message ----------------
function renderMessage(message) {
    const container = document.getElementById("messagesContainer");

    const div = document.createElement("div");
    div.className =
        message.senderId === currentUser.id
            ? "message sent"
            : "message received";

    div.innerHTML = `
        ${message.senderId !== currentUser.id ? `<p class="author">${message.sender?.pseudo || ""}</p>` : ""}
        <p>${message.content}</p>
        <span class="time">${new Date(message.createdAt).toLocaleTimeString()}</span>
    `;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// ---------------- Conversations sidebar ----------------
async function loadConversationsSidebar() {
    try {
        const response = await fetch(`${API_URL}/chat/conversations`, {
            credentials: "include"
        });

        if (!response.ok) return;

        conversations = await response.json();
        const list = document.getElementById("conversationList");
        list.innerHTML = "";

        if (!conversations.length) {
            list.innerHTML = `<li class="conversation-empty">Aucune conversation. Créez-en une depuis la page principale.</li>`;
            return;
        }

        conversations.forEach(conv => {
            const li = document.createElement("li");
            li.className = "conversation-item";
            li.dataset.id = conv.id;
            li.innerHTML = `
                <div class="conversation-title">${conv.name || "Sans nom"}</div>
                <div class="conversation-subtitle">${conv.participants.length} membre${conv.participants.length > 1 ? "s" : ""}</div>
            `;
            li.addEventListener("click", () => selectConversation(conv.id));
            list.appendChild(li);
        });
    } catch (e) {
        console.error("Erreur chargement conversations:", e);
    }
}

function highlightActiveConversation() {
    const items = document.querySelectorAll(".conversation-item");
    items.forEach((item) => {
        if (item.dataset.id === currentConversationId) {
            item.classList.add("active");
        } else {
            item.classList.remove("active");
        }
    });
}

async function selectConversation(id) {
    if (!id || id === currentConversationId) return;

    currentConversationId = id;
    highlightActiveConversation();

    await loadConversationInfo();
    await loadMessages();

    if (socket) {
        socket.emit("joinConversation", { conversationId: currentConversationId });
    }
}

// ---------------- WebSocket ----------------
function setupSocket() {
    socket = io(API_URL, {
        query: { userId: currentUser.id }
    });

    if (currentConversationId) {
        socket.emit("joinConversation", { conversationId: currentConversationId });
    }

    socket.on("newMessage", (message) => {
        if (message.conversationId === currentConversationId) {
            renderMessage(message);
        }
    });
}

// ---------------- Envoyer message ----------------
function sendMessage() {
    const input = document.getElementById("messageInput");
    const content = input.value.trim();

    if (!content) return;
    if (!currentConversationId) return;

    socket.emit("sendMessage", {
        conversationId: currentConversationId,
        senderId: currentUser.id,
        content
    });

    input.value = "";
}

// ---------------- Init ----------------
async function init() {
    await getCurrentUser();
    await loadConversationsSidebar();

    // Choix de la conversation initiale : URL > première dispo
    const params = new URLSearchParams(window.location.search);
    const fromUrl = params.get("conversationId");
    const initialId = fromUrl || (conversations[0] && conversations[0].id);

    if (!initialId) {
        alert("Aucune conversation disponible");
        return;
    }

    await selectConversation(initialId);
    setupSocket();

    const input = document.getElementById("messageInput");
    input.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });
}

init();
</script>

</body>
</html>
